<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Upload Cars - AutoSherpa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .upload-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 25px;
            border-radius: 15px;
        }
        .results-section {
            max-height: 400px;
            overflow-y: auto;
        }
        .navbar-brand {
            font-weight: 700;
            color: #2c3e50 !important;
        }
        .template-download {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .template-download .btn {
            transition: all 0.3s ease;
        }
        
        .template-download .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }
        
        .template-download .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-car me-2"></i>AutoSherpa
                    </h4>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i>Dashboard
                        </a>
                        <a class="nav-link active" href="/upload-cars">
                            <i class="fas fa-upload"></i>Upload Cars
                        </a>
                        <a class="nav-link" href="/upload-images">
                            <i class="fas fa-images"></i>Upload Images
                        </a>
                        <a class="nav-link" href="/view-cars">
                            <i class="fas fa-car-side"></i>View Cars
                        </a>
                        <a class="nav-link" href="/reports">
                            <i class="fas fa-chart-bar"></i>Reports
                        </a>
                        <!-- <a class="nav-link" href="/test-drive-bookings">
                            <i class="fas fa-calendar-check"></i>Test Drive Bookings
                        </a>
                        <a class="nav-link" href="/car-valuations">
                            <i class="fas fa-calculator"></i>Car Valuations
                        </a> -->
                    </nav>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Top Navigation -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand">Upload Cars</span>
                        <div class="navbar-nav ms-auto">
                            <span class="navbar-text me-3">
                                Welcome, <span id="userName">Dealer</span>
                            </span>
                        </div>
                    </div>
                </nav>

                <div class="p-4">
                    <!-- Template Download Section -->
                    <div class="template-download">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-2">
                                    <i class="fas fa-download me-2"></i>Download Excel Template
                                </h5>
                                <p class="mb-0">Use our standardized template to ensure all required fields are properly filled. The template includes sample data and proper column headers.</p>
                                <small class="text-light">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Required fields: Registration Number, Make, Model, Variant, Manufacturing Year, Fuel Type, Transmission Type, Mileage, Estimated Selling Price
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light" id="downloadBtn" onclick="downloadTemplate()">
                                    <i class="fas fa-file-excel me-2"></i>Download Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-info-circle me-2 text-primary"></i>How to Use the Template
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Download the Excel template above</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Fill in your car details following the sample data</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Ensure all required fields are completed</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Save the file as .xlsx format</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Registration numbers must be unique</li>
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Use consistent formatting for dates</li>
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Numeric fields should contain only numbers</li>
                                        <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>Upload the completed file below</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Section -->
                    <div class="upload-card">
                        <h4 class="mb-4">
                            <i class="fas fa-upload me-2"></i>Upload Car Details
                        </h4>
                        
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelFile').click()">
                            <div class="upload-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <h5>Click to select Excel file</h5>
                            <p class="text-muted">or drag and drop your Excel file here</p>
                            <small class="text-muted">Supported formats: .xlsx, .xls</small>
                        </div>
                        
                        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                        
                        <!-- Progress Section -->
                        <div id="progressSection" style="display: none;" class="mt-4">
                            <h6>Uploading and processing...</h6>
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="progressBar">0%</div>
                            </div>
                        </div>
                        
                        <!-- Results Section -->
                        <div id="resultsSection" style="display: none;" class="mt-4">
                            <h6>Upload Results</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body">
                                            <h4 id="successCount">0</h4>
                                            <small>Successful</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white text-center">
                                        <div class="card-body">
                                            <h4 id="errorCount">0</h4>
                                            <small>Failed</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center">
                                        <div class="card-body">
                                            <h4 id="totalCount">0</h4>
                                            <small>Total</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white text-center">
                                        <div class="card-body">
                                            <h4 id="duplicateCount">0</h4>
                                            <small>Duplicates</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detailed Results -->
                            <div class="mt-4">
                                <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="success-tab" data-bs-toggle="tab" data-bs-target="#success" type="button" role="tab">
                                            <i class="fas fa-check-circle me-2"></i>Successful
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" type="button" role="tab">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Errors
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content mt-3" id="resultsTabContent">
                                    <div class="tab-pane fade show active" id="success" role="tabpanel">
                                        <div class="results-section" id="successResults">
                                            <!-- Success results will be populated here -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="errors" role="tabpanel">
                                        <div class="results-section" id="errorResults">
                                            <!-- Error results will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Load user data
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            document.getElementById('userName').textContent = userData.username || 'Dealer';
        }

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }

        // Handle drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadFile(files[0]);
                }
            });
        }

        // Upload file
        async function uploadFile(file) {
            // Validate file type
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please select a valid Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show progress section
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Create FormData
            const formData = new FormData();
            formData.append('excelFile', file);
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/upload-cars', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayResults(result);
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                alert('An error occurred during upload');
            } finally {
                // Hide progress section
                document.getElementById('progressSection').style.display = 'none';
            }
        }

        // Display results
        function displayResults(result) {
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update counts
            document.getElementById('successCount').textContent = result.successful;
            document.getElementById('errorCount').textContent = result.failed;
            document.getElementById('totalCount').textContent = result.totalProcessed;
            document.getElementById('duplicateCount').textContent = 
                result.errors.filter(e => e.message.includes('already exists')).length;
            
            // Display successful imports
            const successResults = document.getElementById('successResults');
            if (result.results.length > 0) {
                const successList = result.results.map(item => `
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Row ${item.row}:</strong> ${item.message}
                        </div>
                    </div>
                `).join('');
                successResults.innerHTML = successList;
            } else {
                successResults.innerHTML = '<p class="text-muted">No successful imports</p>';
            }
            
            // Display errors
            const errorResults = document.getElementById('errorResults');
            if (result.errors.length > 0) {
                const errorList = result.errors.map(item => `
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Row ${item.row}:</strong> ${item.message}
                        </div>
                    </div>
                `).join('');
                errorResults.innerHTML = errorList;
            } else {
                errorResults.innerHTML = '<p class="text-muted">No errors</p>';
            }
        }

        // Download template
        async function downloadTemplate() {
            const downloadBtn = document.getElementById('downloadBtn');
            const originalText = downloadBtn.innerHTML;
            
            try {
                // Show loading state
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
                
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/download-template', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    // Get the blob from the response
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'car_inventory_template.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    downloadBtn.innerHTML = '<i class="fas fa-check me-2"></i>Downloaded!';
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalText;
                        downloadBtn.disabled = false;
                    }, 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to download template');
                }
            } catch (error) {
                console.error('Download error:', error);
                
                // Show error state
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error!';
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }, 2000);
                
                alert('An error occurred while downloading the template: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupDragAndDrop();
        });
    </script>
</body>
</html>
