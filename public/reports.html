<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - AutoSherpa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px 0;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .navbar-brand {
            font-weight: 700;
            color: #2c3e50 !important;
        }
        .report-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .report-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .report-card-body {
            padding: 30px;
        }
        .report-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 sidebar">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-car me-2"></i>AutoSherpa
                    </h4>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i>Dashboard
                        </a>
                        <a class="nav-link" href="/upload-cars">
                            <i class="fas fa-upload"></i>Upload Cars
                        </a>
                        <a class="nav-link" href="/upload-images">
                            <i class="fas fa-images"></i>Upload Images
                        </a>
                        <a class="nav-link" href="/view-cars">
                            <i class="fas fa-car-side"></i>View Cars
                        </a>
                        <a class="nav-link active" href="/reports">
                            <i class="fas fa-chart-bar"></i>Reports
                        </a>
                    </nav>
                    
                    <hr class="my-4">
                    
                    <div class="text-center">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Top Navigation -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand">Reports & Analytics</span>
                        <div class="navbar-nav ms-auto">
                            <span class="navbar-text me-3">
                                Welcome, <span id="userName">Dealer</span>
                            </span>
                        </div>
                    </div>
                </nav>

                <div class="p-4">
                    <!-- Welcome Section -->
                    <div class="welcome-section">
                        <h2>Reports & Analytics Dashboard</h2>
                        <p class="mb-0">Comprehensive insights into your dealership performance and customer interactions</p>
                    </div>

                    <!-- Reports Cards -->
                    <div class="row g-4">
                        <!-- Test Drive Bookings Report -->
                        <div class="col-lg-4 col-md-6">
                            <div class="report-card">
                                <div class="report-card-header">
                                    <i class="fas fa-calendar-check report-icon"></i>
                                    <h4>Test Drive Bookings</h4>
                                    <p class="mb-0">Track and analyze test drive appointments</p>
                                </div>
                                <div class="report-card-body">
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-number" id="totalBookings">0</div>
                                            <div class="stat-label">Total Bookings</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="todayBookings">0</div>
                                            <div class="stat-label">Today</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="weekBookings">0</div>
                                            <div class="stat-label">This Week</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="monthBookings">0</div>
                                            <div class="stat-label">This Month</div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="/test-drive-bookings" class="btn btn-primary">
                                            <i class="fas fa-eye me-2"></i>View Detailed Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Car Valuations Report -->
                        <div class="col-lg-4 col-md-6">
                            <div class="report-card">
                                <div class="report-card-header">
                                    <i class="fas fa-calculator report-icon"></i>
                                    <h4>Car Valuations</h4>
                                    <p class="mb-0">Monitor valuation requests and trends</p>
                                </div>
                                <div class="report-card-body">
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-number" id="totalValuations">0</div>
                                            <div class="stat-label">Total Valuations</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="todayValuations">0</div>
                                            <div class="stat-label">Today</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="weekValuations">0</div>
                                            <div class="stat-label">This Week</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="monthValuations">0</div>
                                            <div class="stat-label">This Month</div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="/car-valuations" class="btn btn-primary">
                                            <i class="fas fa-eye me-2"></i>View Detailed Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Summary Report -->
                        <div class="col-lg-4 col-md-6">
                            <div class="report-card">
                                <div class="report-card-header">
                                    <i class="fas fa-chart-pie report-icon"></i>
                                    <h4>Data Summary</h4>
                                    <p class="mb-0">Comprehensive analytics and insights</p>
                                </div>
                                <div class="report-card-body">
                                    <div class="stats-grid">
                                        <div class="stat-item">
                                            <div class="stat-number" id="totalCars">0</div>
                                            <div class="stat-label">Total Cars</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="availableCars">0</div>
                                            <div class="stat-label">Available</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="carsWithImages">0</div>
                                            <div class="stat-label">With Images</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-number" id="totalInteractions">0</div>
                                            <div class="stat-label">Total Interactions</div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="/reports/data-summary" class="btn btn-primary">
                                            <i class="fas fa-chart-line me-2"></i>View Analytics
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Analytics Overview -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="report-card">
                                <div class="report-card-header">
                                    <h4><i class="fas fa-chart-bar me-2"></i>Quick Analytics Overview</h4>
                                </div>
                                <div class="report-card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Monthly Trends</h6>
                                            <div class="chart-container">
                                                <canvas id="monthlyTrendsChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Activity Distribution</h6>
                                            <div class="chart-container">
                                                <canvas id="activityChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let monthlyTrendsChart, activityChart;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Load user data
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            document.getElementById('userName').textContent = userData.username || 'Dealer';
        }

        // Load reports data
        async function loadReportsData() {
            try {
                const token = localStorage.getItem('authToken');
                
                // Load all data in parallel
                const [carsResponse, bookingsResponse, valuationsResponse] = await Promise.all([
                    fetch('/api/cars', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/test-drive-bookings', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/car-valuations', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const cars = carsResponse.ok ? await carsResponse.json() : [];
                const bookings = bookingsResponse.ok ? await bookingsResponse.json() : [];
                const valuations = valuationsResponse.ok ? await valuationsResponse.json() : [];

                // Update statistics
                updateStatistics(cars, bookings, valuations);
                
                // Create charts
                createCharts(cars, bookings, valuations);

            } catch (error) {
                console.error('Error loading reports data:', error);
            }
        }

        function updateStatistics(cars, bookings, valuations) {
            // Car statistics
            document.getElementById('totalCars').textContent = cars.length;
            document.getElementById('availableCars').textContent = cars.filter(car => car.status === 'available').length;
            document.getElementById('carsWithImages').textContent = cars.filter(car => car.image_paths && car.image_paths.length > 0).length;

            // Booking statistics
            const today = new Date();
            const todayBookings = bookings.filter(booking => {
                const bookingDate = new Date(booking.datetime);
                return bookingDate.toDateString() === today.toDateString();
            }).length;

            const weekBookings = bookings.filter(booking => {
                const bookingDate = new Date(booking.datetime);
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                return bookingDate >= weekAgo;
            }).length;

            const monthBookings = bookings.filter(booking => {
                const bookingDate = new Date(booking.datetime);
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                return bookingDate >= monthAgo;
            }).length;

            document.getElementById('totalBookings').textContent = bookings.length;
            document.getElementById('todayBookings').textContent = todayBookings;
            document.getElementById('weekBookings').textContent = weekBookings;
            document.getElementById('monthBookings').textContent = monthBookings;

            // Valuation statistics
            const todayValuations = valuations.filter(valuation => {
                const createdDate = new Date(valuation.created_at);
                return createdDate.toDateString() === today.toDateString();
            }).length;

            const weekValuations = valuations.filter(valuation => {
                const createdDate = new Date(valuation.created_at);
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                return createdDate >= weekAgo;
            }).length;

            const monthValuations = valuations.filter(valuation => {
                const createdDate = new Date(valuation.created_at);
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                return createdDate >= monthAgo;
            }).length;

            document.getElementById('totalValuations').textContent = valuations.length;
            document.getElementById('todayValuations').textContent = todayValuations;
            document.getElementById('weekValuations').textContent = weekValuations;
            document.getElementById('monthValuations').textContent = monthValuations;

            // Total interactions
            document.getElementById('totalInteractions').textContent = bookings.length + valuations.length;
        }

        function createCharts(cars, bookings, valuations) {
            // Monthly trends chart
            const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
            if (monthlyTrendsChart) monthlyTrendsChart.destroy();
            
            monthlyTrendsChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Test Drive Bookings',
                        data: [12, 19, 3, 5, 2, 3],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }, {
                        label: 'Car Valuations',
                        data: [2, 3, 20, 5, 1, 4],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Activity distribution chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            if (activityChart) activityChart.destroy();
            
            activityChart = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Test Drive Bookings', 'Car Valuations', 'Cars Available'],
                    datasets: [{
                        data: [bookings.length, valuations.length, cars.filter(car => car.status === 'available').length],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            window.location.href = '/';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadReportsData();
        });
    </script>
</body>
</html>
